# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/blocks/index.css — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных, используемые в приложении

Товар

```
export interface IItem {
    id: string;
    description: string;
    image: string;
    title: string;
    category: TCategory;
    price: TPrice;
}
```

Категория товара

```
export type TCategory = 'софт-скил' | 'другое' | 'дополнительное' | 'кнопка' | 'хард скил';
```

Тип цены

```
export type TPrice = number | null;
```

Способ оплаты

```
export type TPayment = 'Онлайн' | 'При получении' | null;
```

Представления товара

```
export type TItemMain = Pick<IItem, 'title' | 'category' | 'image' | 'price'>; // карточка в каталоге

export type TItemModal = Pick<IItem, 'title' | 'category' | 'description' | 'image' | 'price'>; // модалка

export type TItemBasket = Pick<IItem, 'id' | 'title' | 'price'>; // в корзине
```

Покупатель

```
export interface ICustomer {
    payment: TPayment;
    address: string;
    email: string;
    phone: string;
}
```

Модель каталога товаров

```
export interface ICatalogModel {
    items: IItem[];
    preview: string | null;
    setItems(items: IItem[]): void;
    getItem(id: string): IItem | undefined;
    setPreview(id: string | null): void;
    getPreview(): string | null;
}
```

Модель корзины

```
export interface IBasketModel {
    items: Set<string>;
    addItem(id: string): void;
    removeItem(id: string): void;
    calculateTotal(items: IItem[]): TPrice;
    getItemsCount(): number;
    clear(): void;
}
```

Модель пользователя

```
export interface ICustomerModel {
  getCustomer(): ICustomer;
  setCustomer(data: Partial<ICustomer>): void;
  validateStep(fieldsPartial: Partial<ICustomer>): Partial<Record<keyof ICustomer, string | null>>;
  validateAll(): boolean;
}
```

## Архитектура приложения

Приложение построено по архитектуре MVP (Model - View - Presenter). Эта архитектура делит систему на независимые слои: 
- Модель (Model) - отвечает за хранение и изменение данных 
- Представление (View) - представления, отвечает за отображение данных на странице
- Презентер (Presenter) - презентер, отвечает за связь представления и данных.

### Базовый код

#### Класс Api
Содержит логику HTTP-запросов. В конструктор передаётся базовый URL и опциональные заголовки.
Методы: 
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.  
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:
- `on` - подписка на событие
- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие   

### Слой данных

#### Класс CatalogModel
Класс отвечает за хранение и логику работы с данными товаров, полученных от API.
Конструктор класса принимает инстант брокера событий.
В полях класса хранятся следующие данные:
- items: IItem[] - массив всех товаров
- preview: string | null - id товара, выбранной для просмотра в модальном окне
- events: IEvents - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

Класс предоставляет следующие методы:
- setItems(items: IItem[]): void — сохраняет массив товаров;
- getItems(): IItem[] — возвращает массив товаров;
- getItem(id: string): IItem | null — возвращает товар по ID;
- setPreview(id: string | null): void — сохраняет ID товара, выбранного для просмотра;
- getPreview(): string | null — возвращает id текущего элемента для просмотра или null, если превью не установлено.

#### Класс BasketModel
Класс отвечает за хранение и логику работы с корзиной.
Конструктор класса принимает инстант брокера событий.
В полях класса хранятся следующие данные:
- items: Set<string> — множество ID товаров, добавленных в корзину (исключает дубликаты);
- events: IEvents — экземпляр EventEmitter для генерации событий.

Класс предоставляет следующие методы:
- getItems(): Set<string> — возвращает множество ID товаров в корзине;
- addItem(id: string): void — добавляет товар в корзину, если его ещё нет;
- removeItem(id: string): void — удаляет товар из корзины;
- calculateTotal(items: IItem[]): TPrice — вычисляет общую стоимость товаров в корзине;
- getItemsCount(): number — возвращает количество товаров в корзине
- clear(): void — очищает корзину и инициирует событие basket:cleared.
- сеттеры и геттеры для безопасного доступа и изменения множества items

#### Класс CustomerModel
Класс отвечает за хранение и логику работы с данными клиента.
Конструктор класса принимает инстант брокера событий.
В полях класса хранятся следующие данные:

- customer: ICustomer — объект с данными клиента
- events: IEvents — (опционально) экземпляр класса EventEmitter для инициации событий при изменении данных

Класс предоставляет набор методов и свойств для взаимодействия с этими данными:
- getCustomer(): ICustomer — возвращает текущие данные клиента
- setCustomer(data: Partial<ICustomer>): void — обновляет данные клиента частично и вызывает событие изменения данных
- validateStep(fieldsPartial: Partial<ICustomer>): Partial<Record<keyof ICustomer, string | null>> — проверяет валидность переданных полей клиента и возвращает объект с ошибками или null для каждого шага
- validateAll(): boolean — проверяет валидность всех данных клиента и возвращает результат проверки
- сеттеры и геттеры для безопасного доступа и обновления объекта customer

### Классы представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Базовый Класс View
Класс является дженериком и родителем всех компонентов слоя представления. В дженерик принимает тип объекта, в котором данные будут передаваться в метод render для отображения данных в компоненте. В конструктор принимает элемент разметки, являющийся основным родительским контейнером компонента. Содержит метод render, отвечающий за сохранение полученных в параметре данных в полях компонентов через их сеттеры, возвращает обновленный контейнер компонента.

#### Класс CardMain
Класс отвечает за отображение карточки товара в каталоге и открытие модального окна при клике на карточку.
Наследуется от базового класса View<TItemMain>.

#### Класс CardModal
Класс отвечает за отображение карточки товара в модальном окне.
Наследуется от базового класса View<TItemModal>.

#### Класс CardBasket
Класс отвечает за отображение карточки товара в корзине.
Наследуется от базового класса View<TItemBasket>.

#### Класс Modal
Реализует модальное окно с динамическим содержимым. Предоставляет методы open и close для управления отображением модального окна. Устанавливает слушатели на клавиатуру для закрытия по клавише Esc, на клик по оверлею и на кнопку закрытия.

Методы:
- open(template: HTMLElement): void — открывает модальное окно и вставляет переданный DOM-элемент в контейнер содержимого
- close(): void — закрывает модальное окно и очищает содержимое
- setContent(content: HTMLElement): void — вставляет содержимое внутрь модального окна
- bindEvents(): void — навешивает слушатели на кнопку закрытия, оверлей и клавишу Esc для корректного закрытия модального окна

#### Класс BasketView
Класс отображает содержимое корзины в модальном окне.
Отвечает за отрисовку списка товаров, добавленных пользователем, и вывод итоговой стоимости.

#### Класс FormView
Класс реализует форму оформления заказа, состоящую из двух шагов: данные о заказе и контактные данные.
Предоставляет поля ввода, валидируемые при переходе между шагами, и механизмы обновления модели клиента.
Может взаимодействовать с CustomerModel через презентер для сохранения введённых данных.

#### Класс SuccessView
Класс отображает финальный экран успешного оформления заказа.
Cодержит сообщение об успешной покупке и итоговую сумму заказа.

### Слой коммуникации

#### Класс AppApi
Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.

## Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*\

| Событие                   | Описание                                  |
| ------------------------- | ----------------------------------------- |
| `catalog:changed`         | обновился список товаров в каталоге       |
| `catalog:preview`         | пользователь выбрал товар                 |
| `catalog:clear-preview`   | пользователь закрыл модальное окно товара |
| `basket:changed`          | изменился состав корзины                  |
| `basket:item-added`       | товар добавлен в корзину                  |
| `basket:item-removed`     | товар удалён из корзины                   |
| `basket:cleared`          | корзина полностью очищена                 |
| `basket:open`             | пользователь открыл корзину               |
| `basket:checkout`         | пользователь перешёл к заполнению формы   |
| `customer:updated`        | обновились данные пользователя            |
| `customer:validated-step` | валидация текущего шага формы             |
| `customer:validated-all`  | полная валидация формы перед оформлением  |
| `customer:submit`         | пользователь подтвердил оформление заказа |
| `modal:open`              | модальное окно открылось                  |
| `modal:close`             | модальное окно закрылось                  |
| `modal:content-changed`   | сменилось содержимое модального окна      |
| `order:success`           | заказ успешно оформлен                    |
| `order:failed`            | ошибка оформления заказа                  |
